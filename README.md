# TBG-computers-test-assignment
 
[![License: CC BY-NC-ND 4.0](https://img.shields.io/badge/License-CC_BY--NC--ND_4.0-lightgrey.svg)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

Тестовое задание для TBG-Computers

### Текст задания:
>Разработайте веб страницу, используя язык PHP, на которой будет реализован следующий функционал:
>    1. Возможность загрузки pdf документа по кнопке и последующее его отображение в стандартном фрейме.
>    2. Переход по кнопке на страницу для редактирования и сохранения изменений базы данных, которая содержит как минимум два поля: ФИО получателя и email/ID_telegram получателя.
>    3. Кнопка для отправки загруженного pdf файла по адресатам из базы данных выше.
>    4. После отправки файл должен удаляться с сервера.
>В результате также должен быть реализован телеграм бот, в котором адресаты будут получать отправляемый им файл. Также этот файл должен приходить на email, если в бд указан он вместо id тг. >Также обработайте возможные ошибки, которые могут возникнут во время работы реального пользователя. По F5 страница должна обновляться в первоначальное состояние без запроса подтверждения >повторной отправки данных и, соответственно, не должна их отправлять повторно.


### Установка:


    cd server
    composer install
    sail up -d
    
    cp .env.example .env

Добавить токен для телеграмм бота в .env в параметр TELEGRAM_BOT_TOKEN

    sail artisan key:generate
    sail artisan migrate
    sail artisan storage:link
    sail artisan queue:work
    sail artisan orchid:admin admin admin@admin.com password

### Использование:
- Зайти на `{адрес хоста}/admin` (по умолчанию localhost)
- Выполнить логин с почтой и паролем из установки (admin@admin.com, password)
- Следовать инструкции в приложении

Тестовый сервер почти Mailpit: `localhost:8025`

### Устройство

#### Модели
Основой проекта являются модели Parcel и Recipient. 

Recipient - модель храняшая получателей рассылки. Модель содержит основые колонки: \
name - Имя получателя \
address - Адрес получателя \
address_type - тип адреса получателя, реазлиованный через кастомный enum Тип App/Types/AddressType

Parcel - модель хранящая отправляемый файл. Хранение файла предусмотренно через трейт "Attachable".

#### Экраны
Экран Orchid UploadFileScreen позволяет выполнить загрузку файла на сервер и сохранение адреса файла в attachment модели Parcel, а так же удалить присоединённый файл. При загрузке файла реализована обработка сообщением потенциальной ошибки пользователя - отсутствия загруженного файла. Так же ограничен тип загружаемого файла.\
Экран ManageScedule позволяет просматривать таблицу, удалять получателей, вызывать экран добавления и редактирования получателей. Таблица заполняется из модели Recipient.\
Экран RecipientEditScreen позволяет редактировать, добавлять и удалять получателей, взаимодействуя с отдельными объектами модели Recipient. Поля проходят предварительную валидацию. Предусмотрена обработка потенциальных ошибок введения данных в виде всплывающего предупреждения.\
Экран SendFileScreen позволяет просматривать список получателей и выбирать цели для отправки и, собственно, выполнять отправку файла, в случае отсутствия прикреплённого файла - кнопка рассылки отображаться не будет. 

#### Лэйауты
RecipientsLayout - таблица для отображения и доступа к редактированию/удалению получателей\
MailListLayout - таблица для отображения списка известных адресов и выбора получателей

Отображение страниц-экранов организованно в виде бокового меню стандартными средствами Orchid.

#### Прочее
EmailSendJob - джоб для очереди задач, собственно, выполняющая рассылку файл используя фасад Mail для отсылки через имейл и Notification для отправки через бота

### Ключевые моменты

Методы `upload()` и `purge()` экрана UploadFileScreen манипулируют единственной записью модели Parcel присоединяя или удаляя присоединённый файл.\
Методы `save()` экрана  RecipientEditScreen редактирует записи в модели Recipient, в том же методе реализованна валидация в полей.\
Для передачи данных о получателях к экрану редактирования используется запрос Orhcid 'recipients'.\
Метод `submit()` экрана SendFileScreen выполняет составление последовательности задач для Redis. Метод реализован таким образом, что удаление файла из хранилища происходит после отработки очереди.\
Приложение контейнеризованно в docker используя Laravel Sail.



Язык: PHP

Используемые технологии: 
- <img src="https://img.shields.io/badge/Laravel-FF2D20?style=for-the-badge&logo=laravel&logoColor=white"> + [Orchid](https://orchid.software/)
- <img src="https://img.shields.io/badge/redis-CC0000.svg?&style=for-the-badge&logo=redis&logoColor=white">
- <img src="https://img.shields.io/badge/Docker-2CA5E0?style=for-the-badge&logo=docker&logoColor=white"> (via [Laravel Sail](https://laravel.com/docs/10.x/sail))



